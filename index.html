<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>אלפון קשר - Alfon</title>
    <style>
        :root {
            --primary: #007bff;
            --bg: #f0f2f5;
            --text: #1c1e21;
        }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background: var(--bg); 
            padding: 15px; 
            margin: 0;
            color: var(--text);
        }
        .container { 
            max-width: 600px; 
            margin: 20px auto; 
            background: white; 
            padding: 20px; 
            border-radius: 16px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.08); 
        }
        h1 { text-align: center; font-size: 24px; margin-bottom: 25px; }
        .search-box {
            width: 100%;
            padding: 12px;
            margin-bottom: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 16px;
        }
        .contact-row { 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            padding: 12px 0; 
            border-bottom: 1px solid #f0f0f0; 
        }
        .contact-info { display: flex; flex-direction: column; flex-grow: 1; }
        .name { font-weight: 600; font-size: 1.05em; margin-bottom: 4px; }
        .details { color: #65676b; font-size: 0.85em; }
        .download-btn {
            background: var(--primary); 
            color: white; 
            padding: 10px 18px;
            border-radius: 25px; 
            text-decoration: none; 
            font-size: 14px;
            font-weight: 500;
            white-space: nowrap;
            margin-right: 10px;
            transition: opacity 0.2s;
        }
        .download-btn:active { opacity: 0.7; }
        .error { color: #d93025; background: #fce8e6; padding: 15px; border-radius: 8px; text-align: center; }
    </style>
</head>
<body>

<div class="container">
    <h1>ספר טלפונים פלוגתי</h1>
    
    <input type="text" id="search" class="search-box" placeholder="חפש לפי שם או פלוגה...">
    
    <div id="list">טוען נתונים...</div>
</div>

<script>
    const BASE_ALFON_URL = 'https://dekelcom.github.io/alfon';
    let allContacts = [];

    async function loadContacts() {
        const listDiv = document.getElementById('list');
        try {
            // 1. משיכת הנתונים מה-JSON שנוצר ב-Actions
            const response = await fetch(`${BASE_ALFON_URL}/contacts.json`);
            if (!response.ok) throw new Error('לא נמצא קובץ נתונים');
            
            allContacts = await response.json();
            renderContacts(allContacts);

            // 2. הוספת אפשרות חיפוש
            document.getElementById('search').addEventListener('input', (e) => {
                const term = e.target.value.toLowerCase();
                const filtered = allContacts.filter(c => 
                    c.name.toLowerCase().includes(term) || 
                    (c.company && c.company.toLowerCase().includes(term))
                );
                renderContacts(filtered);
            });

        } catch (error) {
            listDiv.innerHTML = `
                <div class="error">
                    <strong>שגיאה בטעינה</strong><br>
                    ${error.message}<br>
                    <small>ודא ש-GitHub Pages מוגדר כראוי ב-Settings</small>
                </div>`;
        }
    }

    function renderContacts(contacts) {
        const listDiv = document.getElementById('list');
        if (contacts.length === 0) {
            listDiv.innerHTML = '<p style="text-align:center">לא נמצאו תוצאות</p>';
            return;
        }

        listDiv.innerHTML = contacts.map(c => {
            // ניקוי המספר מכל תו שאינו ספרה (מטפל בסימני +, מקפים ותווים נסתרים)
            const rawPhone = c.mobileE164 || c.mobile || "";
            const fileId = rawPhone.replace(/\D/g, ''); 
            const vcfUrl = `${BASE_ALFON_URL}/vcards/${fileId}.vcf`;
            
            return `
                <div class="contact-row">
                    <div class="contact-info">
                        <span class="name">${c.name}</span>
                        <span class="details">
                            ${c.company ? 'פלוגה ' + c.company : ''} 
                            ${c.role ? '| ' + c.role : ''}
                        </span>
                        <span class="details" dir="ltr">${rawPhone}</span>
                    </div>
                    <a href="${vcfUrl}" 
                       type="text/vcard" 
                       target="_blank"
                       class="download-btn">
                       שמור איש קשר
                    </a>
                </div>
            `;
        }).join('');
    }

    loadContacts();
</script>

</body>
</html>
